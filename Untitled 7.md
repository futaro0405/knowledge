# 詳細設計
## API 仕様
### エンドポイント
- URL:
	- `POST /api/admin/common/alcohol/upload`
- リクエストパラメーター:
	- file: アップロードするXLSXファイル
	- （必要に応じて認証トークン等のヘッダー情報）

### レスポンス例
- 成功時:
```
{
	account: {...},
	csrf: {...}
}
```
  
- エラー時:
```
{
	data: {
		errors: [{
			sheet: "alcohols",
			row: x,
			message: "xxxxxxx"
		},{...}
		],
	    count: 2
	},
	account: {...},
	csrf: {...}
}
```
## バックエンド処理
### アップロードファイルの検証
- ファイル形式・サイズチェック:
	- 拡張子（.xlsx）およびMIMEタイプの確認。
	- 許容サイズ（最大5MB）を超えていないか検証。
### XLSXファイルのパース
- ライブラリ:
	- [excelize](https://xuri.me/excelize/ja/)を使用する。
- テンプレート構成:
	- ファイルは必ず「alcohols」シートと「makers」シートの2シート構成とする。
### 各行データの検証
- 必須項目チェック:
    - `alcohols` シート
        - ブランド名 `product_code`
        - メーカー `maker`
        - ジャンルID `genre`
        - 商品名 `product_name`
        - アルコール度数 `alcohol_content`
        - 製品説明 `explanation`
        - 製品情報 `product_information`
        - 販売日 `release_date`
        - 製品ページ `product_page`
        - AmazonアフィリエイトURL `amazon_url`
        - 楽天アフィリエイトURL `rakuten_url`
    - `makers` シート
        - メーカーブランド名 `brand_name`
        - メーカー名 `maker_name`
        - メーカー和名 `maker_name_jp`
        - 国 `country`
        - 創業日 `founding_date`
        - メーカーホームページ `home_page`
- データの値が妥当かのチェック:
    - アルコール度数は0～100の範囲に収まっているか。
    - 日付や文字列のフォーマット。
    - 各項目について期待するデータ型・範囲に沿っているか判定。
- データ重複チェック:
    - 既存データと同一キーが存在しないか確認。
    - 重複が見られる場合はエラーに含める。      
※ 各検証は、1行ずつループ処理により実施し、エラーのある行は登録処理を中断する。
### 一括登録処理（トランザクション管理）
- 全データ正常の場合のみ実行:
	- 検証完了後、エラーがない行をDBトランザクション内で一括更新／登録処理を開始。
- データマッピング:
	- 「alcohols」シートのデータを以下のテーブルにマッピングする（例）:
		- alcohols
		- alcohol_images
		- medias
    - 「maker」シートのデータを maker テーブルにマッピングする。
    - 各項目の対応は事前に定義したマッピングルールに基づき、必要に応じて正規化・変換を実施。
- コミット／ロールバック:
	- 登録処理中にエラーが発生しない場合はコミット、エラーが発生した場合はトランザクションをロールバックし、エラー内容を集約してレスポンスとして返す。
## フロントエンドとの連携
- 画面遷移:
	- お酒詳細画面から「一括登録画面」への遷移ボタンを実装。
- UI:
    - ファイルアップロード用コンポーネント（ファイル選択＆ドラッグ＆ドロップ）
    - テンプレートのダウンロードリンク
    - APIレスポンスに基づいたアップロード結果（成功件数、各エラーの内容）を表示するパネル
