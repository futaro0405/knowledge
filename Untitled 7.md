# **詳細設計**
## API 仕様
### エンドポイント
- URL:
	- `POST /api/admin/common/alcohol/upload`
- リクエストパラメーター:
	- file: アップロードするXLSXファイル
	- （必要に応じて認証トークン等のヘッダー情報）

### レスポンス例
- 成功時:
```
{
	account: {...},
	csrf: {...}
}
```
  
- エラー時:
```
{
	data: {
		errors: [{
			sheet: "alcohols",
			row: x,
			message: "xxxxxxx"
		},{...}
		],
	    count: 2
	},
	account: {...},
	csrf: {...}
}
```
## バックエンド処理
### アップロードファイルの検証
- ファイル形式・サイズチェック:
	- 拡張子（.xlsx）およびMIMEタイプの確認。
	- 許容サイズ（最大5MB）を超えていないか検証。
### XLSXファイルのパース
- ライブラリ:
	- [excelize](https://xuri.me/excelize/ja/)を使用する。
- テンプレート構成:
	- ファイルは必ず「alcohols」シートと「makers」シートの2シート構成とする。
### 各行データの検証
- 必須項目チェック:
    - `alcohols` シート
        - `product_code
        - `maker_id
        - `genre_id`
        - `product_name`
        - `alcohol_content`
        - `explanation`
        - `product_information`
        - `release_date`
        - `product_page`
        - `amazon_url`
        - `rakuten_url`
    - `makers` シート
        - `brand_name	maker_name	maker_name_jp	country	founding_date	home_page
- **データの値が妥当かのチェック:**
    - アルコール度数は0～100の範囲に収まっているか。
    - 日付や文字列のフォーマット、長さのチェックなど。
    - その他、各項目について期待するデータ型・範囲に沿っているか判定。
- データ重複チェック:
    - 既存データと同一キー（例：銘柄コード、メーカーIDなど）が存在しないか確認。
    - 重複が見られる場合はエラーに含める。      
※ 各検証は、1行ずつループ処理により実施し、エラーが1件でもあれば登録処理は中断する。
### **2.4. 一括登録処理（トランザクション管理）**

- **全データ正常の場合のみ実行:**
    
    - 検証完了後、エラーが全くなければ、DBトランザクション内で一括更新／登録処理を開始。
        
    
- **データマッピング:**
    
    - 「お酒」シートのデータを以下のテーブルにマッピングする（例）:
        
        - alcohols
            
        - alcohol_info
            
        - alcohol_images
            
        - medias
            
        
    - 「メーカー」シートのデータを maker テーブルにマッピングする。
        
    - 各項目の対応は事前に定義したマッピングルールに基づき、必要に応じて正規化・変換を実施。
        
    
- **コミット／ロールバック:**
    
    - 登録処理中にエラーが発生しない場合はコミット、エラーが発生した場合はトランザクションをロールバックし、エラー内容を集約してレスポンスとして返す。
        
    

  

### **2.5. ログ記録と監視**

- **アップロード履歴:**
    
    - アップロード日時、実行者、ファイル名、登録結果（成功／エラー情報）をログテーブルに記録。
        
    
- **エラーログ:**
    
    - 各検証エラーの詳細（行番号、エラー内容）をシステムログおよびDBログテーブルに記録。
        
    

  

## **3. データベース設計の詳細**

  

### **3.1. 既存テーブルへの更新**

- **対象テーブル:**
    
    - alcohols, alcohol_info, alcohol_images, medias（「お酒」シートのデータ用）
        
    - maker（「メーカー」シートのデータ用）
        
    
- **データマッピング例:**
    
    - 「お酒」シート
        
        - 列A：銘柄名 → alcohols.name
            
        - 列B：カテゴリ → alcohol_info.category
            
        - 列C：アルコール度数 → alcohol_info.abv
            
        - 列D：画像URL → alcohol_images.image_url
            
        - 列E：メディア情報 → medias.media_url 等
            
        
    - 「メーカー」シート
        
        - 列A：メーカー名 → maker.name
            
        - 列B：住所 → maker.address
            
        - 列C：連絡先 → maker.contact など
            
        
    

  

### **3.2. 必要な新規テーブル（オプション）**

- **アップロード履歴テーブル:**
    
    - カラム例：upload_id, admin_user_id, upload_datetime, file_name, result_status, message
        
    
- **エラーログテーブル:**
    
    - カラム例：error_id, upload_id, row_number, error_message
        
    

  

## **4. フロントエンドとの連携**

- **画面遷移:**
    
    - お酒詳細画面から「一括登録画面」への遷移ボタンを実装。
        
    
- **UI:**
    
    - ファイルアップロード用コンポーネント（ファイル選択＆ドラッグ＆ドロップ）
        
    - テンプレートのダウンロードリンク
        
    - APIレスポンスに基づいたアップロード結果（成功件数、各エラーの内容）を表示するパネル
        
    

  

## **5. セキュリティ・パフォーマンス考慮**

- **セキュリティ:**
    
    - APIは管理者のみアクセス可能とし、認証トークンを必須とする。
        
    - ファイルアップロード時の拡張子、MIMEタイプ、サイズの再チェックをサーバー側で徹底。
        
    
- **パフォーマンス:**
    
    - 大容量ファイル向けに、パース処理とバッチ更新のための効率的なアルゴリズムを採用（必要に応じ非同期処理を検討）。
        
    

---

この詳細設計を基に、実装フェーズでは、各モジュールのコード実装、単体テスト・統合テスト計画を策定し、実際のシステム更新を進めます。各プロセスのエラーハンドリングやログ出力など、運用時のトラブルシュートも視野に入れた実装を心がけることが重要です。