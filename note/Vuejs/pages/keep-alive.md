# KeepAlive
`<KeepAlive>` は、Vue.jsで提供されている特別なビルトインコンポーネントです。
これは、動的に切り替えられる複数のコンポーネントのインスタンスを一時的に保存（キャッシュ）するために使用します。
キャッシュを使うことで、コンポーネントを切り替えたときに以前の状態を保持することができます。
## 基本的な使い方
「コンポーネントの基礎」の章で紹介された `<component>` という特別な要素を使うことで、動的にコンポーネントを切り替えることができます。
例えば以下のように使用します。

```vue
<template>
  <component :is="activeComponent" />
</template>
```

デフォルトでは、アクティブなコンポーネントが別のコンポーネントに切り替えられると、そのインスタンスはアンマウント（削除）されます。
これにより、コンポーネントの状態（例えば入力フォームの内容やカウンターの値）が失われてしまいます。
そして、再度そのコンポーネントを表示するときには、新しいインスタンスが初期状態で作成されます。

例えば、ステートフルな（状態を持つ）2つのコンポーネントがあるとします。
コンポーネントAにはカウンターがあり、コンポーネントBには `v-model` を使ってメッセージが同期される入力フィールドがあります。
これらのコンポーネント間で状態を変更して切り替えた後、もう一度元のコンポーネントに戻ってみてください。

このように、`<KeepAlive>` を使用すると、コンポーネントがアンマウントされず、以前の状態が保持されるため、再度表示したときにも前の状態が維持されます。

## Include / Exclude
デフォルトでは、`<KeepAlive>` はすべてのコンポーネントをキャッシュします。
しかし、`include` と `exclude` という特別なプロパティを使って、どのコンポーネントをキャッシュするかを選ぶことができます。
このプロパティにはカンマで区切った文字列、正規表現、またはこれらを含む配列を指定することができます。

```html
<template>
  <!-- カンマで区切った文字列 -->
  <KeepAlive include="a,b">
    <component :is="view" />
  </KeepAlive>

  <!-- 正規表現（v-bindを使う）-->
  <KeepAlive :include="/a|b/">
    <component :is="view" />
  </KeepAlive>

  <!-- 配列（v-bindを使う）-->
  <KeepAlive :include="['a', 'b']">
    <component :is="view" />
  </KeepAlive>
</template>
```

これらの設定は、コンポーネントの `name` オプションに基づいてチェックされるため、キャッシュしたいコンポーネントには `name` オプションを設定する必要があります。
#### TIPS
バージョン 3.2.34 以降では、`<script setup>` を使った単一ファイルコンポーネントは、ファイル名から自動的に `name` オプションを推測するため、手動で名前を設定する必要はありません。

## キャッシュインスタンスの最大数

`max` プロパティを使用すると、キャッシュできるコンポーネントインスタンスの最大数を制限できます。
このプロパティが設定されている場合、`<KeepAlive>` は「LRUキャッシュ」のように機能します。

LRUキャッシュとは、「Least Recently Used」（最も最近使用されていない）の略で、最も長い間使用されていないキャッシュデータを優先的に削除する仕組みです。
`<KeepAlive>` が保持するキャッシュインスタンスの数が指定された `max` 値を超えそうになると、最も過去にアクセスされたキャッシュインスタンスが破棄され、新しいキャッシュ用のスペースが作られます。

以下は、最大10個のコンポーネントインスタンスをキャッシュする設定の例です：

```html
<template>
  <KeepAlive :max="10">
    <component :is="activeComponent" />
  </KeepAlive>
</template>
```

この設定により、キャッシュされるインスタンスの数は最大で10個に制限され、それを超えた場合は古いものから順に削除されます。

## キャッシュされたインスタンスのライフサイクル
`<KeepAlive>`コンポーネントを使うと、あるコンポーネントがDOMから削除されても、そのインスタンスは完全には消えません。
代わりに、そのコンポーネントは非アクティブな状態に変わり、キャッシュの一部として保存されます。
そして、そのコンポーネントが再びDOMに挿入されると、アクティブな状態に戻ります。
### ライフサイクルフック
`<KeepAlive>`で管理されているコンポーネントは、以下の2つの状態に対応するライフサイクルフックを使うことができます：
1. **onActivated**: コンポーネントが初めてDOMにマウントされたとき、もしくはキャッシュから再度挿入されたときに呼ばれる。
2. **onDeactivated**: コンポーネントがDOMから削除されてキャッシュに保存されるとき、もしくは完全にアンマウントされるときに呼ばれる。

以下は、これらのフックの使用例です：

```vue
<script setup>
import { onActivated, onDeactivated } from 'vue'

onActivated(() => {
  // コンポーネントが最初にマウントされるときや
  // キャッシュから再挿入されるたびに実行されるコードを書く
})

onDeactivated(() => {
  // コンポーネントがDOMから削除されてキャッシュに保存されるときや
  // 完全にアンマウントされるときに実行されるコードを書く
})
</script>
```
### 注意点
- **onActivated**は、コンポーネントが初めてDOMにマウントされるときにも呼ばれます。
- **onDeactivated**は、コンポーネントが完全にアンマウントされるときにも呼ばれます。
- これらのライフサイクルフックは、`<KeepAlive>`でキャッシュされたルートコンポーネントだけでなく、その内部にある子コンポーネントにも適用されます。

