# 並行処理と並列処理
「並行処理」と「並列処理」という2つの言葉があります。これらは似ていて混乱しやすいですが、実は全く違う意味を持っています。  
プログラミングの話をするとき、この2つの言葉を間違えると大きな誤解が生じる可能性があります。例えば、あなたが「並行処理」について話しているつもりなのに、相手が「並列処理」のことだと思っていたら、話がかみ合わなくなってしまいます。  
そのため、この章ではまず、これら2つの言葉の違いをはっきりさせます。その後で、Goプログラミング言語の特徴的な機能である「ゴールーチン」や「チャネル」について学ぶ前に、「並行処理」の良い点や難しい点について説明していきます。  

## 「並行」と「並列」の違いを理解する
「並行」と「並列」の違いは、プログラミングの世界で非常に重要です。そのため、多くの人がさまざまな方法でこの違いを説明しています。ここでは、いくつかの視点からこの2つの概念の違いを見ていきます。  

### 時間の観点から見た違い
「並行処理」と「並列処理」の違いを理解するための1つの方法は、時間の捉え方に注目することです。  
- 並行処理：
    - 一定の時間の幅の中で、複数の仕事（タスク）を扱います。
    - 例えば、1日の間に複数の仕事をこなすようなイメージです。
- 並列処理：
    - ある瞬間（時間の一点）で、複数の仕事を同時に行います。
    - 例えば、ちょうど正午に複数の仕事を同時に行うようなイメージです。

この時間に関する違いは、「Linux System Programming」という本の中でも言及されています。この考え方は、「並行」と「並列」の違いを理解する上で役立ちます。  
![](https://storage.googleapis.com/zenn-user-upload/6c60c323c391bdba85da98fe.png)
### 「プログラムの設計」と「プログラムの動き方」から見た違い
「並行」と「並列」という言葉は、プログラミングの異なる側面を指しています。Go言語の公式ブログにある有名な記事「Concurrency is not parallelism」（並行性は並列性ではない）では、この違いを次のように説明しています。  

- 並行処理（Concurrency）
    - プログラムの「設計」に関係します。
    - 複数の処理を別々に実行できるように、プログラムを組み立てる方法です。
    - 一度にたくさんのことを「扱える」ようにすることです。
1. 並列処理（Parallelism）：
    - プログラムの「実際の動き方」に関係します。
    - 複数の処理を同時に実行することです。
    - 一度にたくさんのことを実際に「行う」ことです。

簡単に言えば、

- 並行処理は「同時に多くのことを管理する方法」を考えること
- 並列処理は「実際に多くのことを同時に行うこと」

この違いを理解することで、効率的なプログラムを設計し、実行する方法をより深く理解できます。  

![](https://storage.googleapis.com/zenn-user-upload/6e88778e756d4f04c7cd5bea.png)
### 「ソフトウェア」と「ハードウェア」の視点から見た違い
「並行」と「並列」の違いを理解するもう一つの方法は、ソフトウェアとハードウェアの観点から考えることです。

- 並行処理（Concurrency）
    - ソフトウェアの考え方に関係します。
    - 問題を解決するためのプログラミングの方法です。
    - どのようにプログラムを設計するかという話です。
- 並列処理（Parallelism）
    - ハードウェアの能力に関係します。
    - コンピューターが実際に同時に複数の処理を行う能力のことです。
    - 並行処理を実現するための、機械の特徴です。

### 「プログラムの書き方」と「プログラムの動き方」の視点から見た違い
似たような考え方で、「コード（プログラムの書き方）」と「プロセス（プログラムの動き方）」という観点からも違いを説明できます。

- 並行性：プログラムコードをどう書くかという話
- 並列性：書かれたプログラムが実際にどう動くかという話

#### 重要なポイント
1. プログラマーは「並列に動くコード」を直接書くわけではありません。代わりに、「並列に動かせる可能性のある並行なコード」を書きます。
2. 書いたコードが実際に並列に動いているかどうかは、プログラマーが気にする必要はありません。

これらの視点は、並行処理と並列処理の違いをより深く理解するのに役立ちます。プログラムを設計する際の考え方（並行処理）と、そのプログラムが実際にどう動くか（並列処理）を区別することが大切です。

## Go言語における「並行」処理
Go言語では、「並行」処理を実現するための仕組みとして、ゴールーチンとチャネルを提供しています。  
重要なポイント： Go言語で作れるのは「プログラムコード」や「ソフトウェア」です。これらの特性を表すのは「並行性」です。

### なぜ並行処理を使うのか？
ゴールーチンを使って並行なコードを書く理由は主に2つあります。

#### プログラムの実行が速くなる可能性がある
並行に書かれたコードは、複数のCPUで同時に実行される可能性があります。
もし実際に並列実行されれば、プログラムの実行時間が短くなります。
#### 現実世界をより自然に表現できる
現実世界では、多くの事象が同時に、独立して起こっています。
Rob Pike氏（Go言語の開発者の一人）は次のように説明しています。

>「世界を見渡すと、多くのことが同時に、独立して起こっています。
>例えば、講演中の聴衆がそれぞれ自分のことをしたり、ツイートしたりしています。外では人々が歩き、車が走っています。
>これらはすべて独立した事象です。もしこのような現実世界をプログラムで表現しようとするなら、すべてを一つの順序で処理する方法（シーケンシャルな実行）は適切ではありません。」

つまり、現実世界の独立した事象を表現するには、並行処理の方が適しているということです。
このように、並行処理を使うことで、プログラムの効率を上げたり、現実世界をより自然に表現したりすることができます。Go言語は、このような並行処理を簡単に実現できるように設計されています。

### 並行処理の難しさ
並行処理には多くの利点がありますが、同時に難しい面もあります。一般的に「並行処理は難しい」と言われる理由をいくつか説明します。

1. **実行順序が予測できない**
    - 並行に実行される2つのコード（AとB）があった場合、AとBどちらが先に実行されるかは実行するまでわかりません。
    - コードを上から下に書くと、上から順に実行されると思いがちですが、並行処理ではそうとは限りません。
2. **競合状態（Race Condition）の問題**
    - 競合状態とは、コードを実行するたびに結果が変わる可能性がある状態のことです。
    - 例：複数の処理が同じ変数を同時に変更しようとする場合、最終的な値が予測不可能になることがあります。
3. **共有メモリへの適切なアクセス**
    - 競合状態を避けるために、メモリにロックをかけることがありますが、これを間違えるとデッドロック（全ての処理が互いを待ち合って進まなくなる状態）を引き起こす可能性があります。
4. **必ずしも実行時間が短くならない**
    - 並行処理が常にプログラムを速くするわけではありません。以下のような場合、効果が限定的になることがあります： a. 順序依存の処理：前の処理の結果を使って次の処理を行う場合など。 b. コンテキストスイッチのオーバーヘッド：処理の切り替えに時間がかかりすぎる場合。 c. CPU主体の処理：CPUの処理能力が主な制限要因となる場合。
5. **適切な並行処理の設計**
    - 問題の性質によっては、並行処理の恩恵を受けにくい場合があります。
    - 例：「エラトステネスのふるい」アルゴリズムは、並列処理に向いていない構造を持っています。

これらの難しさを理解し、適切に対処することが、効果的な並行プログラミングには重要です。Go言語は並行処理を簡単に書けるように設計されていますが、これらの問題に注意を払う必要があります。