# データの取得
データベースを作成し、シードしたので、アプリケーションのデータを取得するさまざまな方法について議論し、ダッシュボードの概要ページを構築しましょう。  

この章では以下のトピックを扱います。  

1. データ取得のアプローチについて学ぶ：API、ORM、SQLなど
2. サーバーコンポーネントがバックエンドリソースにより安全にアクセスするのに役立つ方法
3. ネットワークウォーターフォールとは何か
4. JavaScriptパターンを使用して並列データ取得を実装する方法

# データ取得方法の選択
**APIレイヤー**  
APIはアプリケーションコードとデータベースの間の中間層です。  
APIを使用する場合がいくつかあります。  

- APIを提供するサードパーティサービスを使用している場合。
- クライアントからデータを取得する際、データベースのシークレットをクライアントに公開しないように、サーバー上で実行されるAPIレイヤーが必要な場合。

Next.jsでは、[Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)を使用してAPIエンドポイントを作成できます。  

**データベースクエリ**  
フルスタックアプリケーションを作成する場合、データベースと対話するためのロジックを書く必要もあります。  
Postgresのような[リレーショナルデータベース](https://aws.amazon.com/relational-database/)の場合、SQLやORMを使用してこれを行うことができます。  

データベースクエリを書く必要がある場合がいくつかあります。

- APIエンドポイントを作成する際、データベースと対話するためのロジックを書く必要があります。
- React Server Components（サーバー上でデータを取得）を使用している場合、APIレイヤーをスキップし、データベースのシークレットをクライアントに公開するリスクなしに直接データベースにクエリを行うことができます。

React Server Componentsについてさらに学びましょう。  

# サーバーコンポーネントを使用したデータ取得
デフォルトでは、Next.jsアプリケーションは**React Server Components**を使用します。  
Server Componentsでデータを取得することは比較的新しいアプローチであり、以下のような利点があります。  

1. Server Componentsはプロミスをサポートしており、データ取得などの非同期タスクにより簡単なソリューションを提供します。`useEffect`、`useState`、またはデータ取得ライブラリを使用せずに、`async/await`構文を使用できます。
2. Server Componentsはサーバー上で実行されるため、高コストのデータ取得やロジックをサーバー上に保持し、結果のみをクライアントに送信できます。
3. 前述のように、Server Componentsはサーバー上で実行されるため、追加のAPIレイヤーなしで直接データベースにクエリを行うことができます。

# SQLの使用
ダッシュボードプロジェクトでは、Vercel Postgres SDKとSQLを使用してデータベースクエリを記述します。  
SQLを使用する理由はいくつかあります。  

1. SQLはリレーショナルデータベースのクエリに関する業界標準です（例：ORMは内部でSQLを生成します）。
2. SQLの基本的な理解は、リレーショナルデータベースの基礎を理解するのに役立ち、他のツールにも知識を応用できます。
3. SQLは多用途で、特定のデータの取得や操作が可能です。
4. Vercel Postgres SDKはSQLインジェクションに対する保護を提供します。

SQLを使ったことがなくても心配しないでください。  
クエリは提供されています。  

`/app/lib/data.ts`に移動すると、`@vercel/postgres`から`sql`関数をインポートしているのがわかります。  
この関数を使用してデータベースにクエリを行うことができます。  

**/app/lib/data.ts**
```javascript
import { sql } from '@vercel/postgres';
 
// ...
```

任意のサーバーコンポーネント内で`sql`を呼び出すことができます。  
ただし、コンポーネントをより簡単に操作できるように、すべてのデータクエリは`data.ts`ファイルに保持されており、コンポーネントにインポートできます。  

**注意**
第6章で独自のデータベースプロバイダーを使用した場合、データベースクエリをそのプロバイダーで動作するように更新する必要があります。クエリは `/app/lib/data.ts` で見つけることができます。  

