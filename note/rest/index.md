---
tags: rest
---
## webの仕組み
クライアントからサーバーにリクエスト
サーバーからクライアントへレスポンスすることで情報伝達する。

## webとは
HTTPなどのインターネット関連技術を利用してメッセージ送受信を行う技術。
また、それら技術を適用して展開されたサービス。

## APIとは
Application Programming Interface
機能やデータを外部から呼び出して利用できるように定めた規約

## WebAPIとは
HTTPなどのインターネット関連技術を利用してプログラムが読み書きしやすい形でメッセージ送受信を行えるように定義した規約。
また規約を実装して展開されるサービス。

## webサイト、webサービス、webAPIの違い
### webサイト
静的コンテンツ
運営者からの情報提供が目的。
ユーザーはサイト内を徘徊することで目的を果たす。

### webサービス
動的コンテンツ。
ユーザーが抱える問題を解決することが目的。
ユーザーはサービスに対して情報をため込む/引き出すといった操作を能動的にすることで目的を果たす。

### webAPI
webサービスで提供している機能やデータを外からプログラムが読み取りやすい形で利用できるように定めた規約またはその実装。

## webAPIは何ができるか
第3者が情報を利活用して新たな機能を開発。

## WebAPIは何がうれしいか
APIエコノミーン実現による自社サービスの発展。

webAPIを提供する
↓
関連サービスができる
- スマホアプリ
- ガジェット・プラグイン
- 自サービスがより成長する
↓
自社サービスが成長
↑サイクル

## 何を公開するか
価値あるもの（機能やデータ）はすべて公開

## 公開によるリスクと対策
一番の問題は入るはずの利益が入らなくなること
- ユーザーが減る
- リソースが圧迫される
- データが盗まれる

webapiで対策すべきは上2つ

### ユーザーが減る
原因1:
他のサービスが優れている
作りこむ機能の優先順位を間違っている

対策:
ユーザー獲得している他サービスの機能を取り込む

原因2:
他サービスが劣っている
自サービスの評価が落とされている

対策:
該当サービスに対してwebapiの提供を停止する
→APIキー停止

### リソースが圧迫される
原因:
API化することで機械的にデータ取得しやすくなっている

対策:
該当サービスに対してwebapiの利用制限をかける
→レートリミット

# HTTPリクエスト
リクエストは3要素で構成される。
- リクエストライン
- ヘッダー
- ボディ

### リクエストライン
メソッド、リクエストURL、httpバージョンで構成されている
#### メソッド
POSTとかGETとか。
8種類ある。そのうち押さえておきたい4種類。

| メソッド | 意味 | よく見るやつ |
|:--|:--|:--|
| OPTIONS | サーバー側が提供する機能の確認 | |
| GET | リソースの取得 | ○ |
| HEAD | リソースのヘッダー（meta情報）の取得 | |
| POST | 従属リソースの作成 | ○ |
| PUT | 新規リソースの作成、リソースの更新 | ○ |
| DELETE | リソースの削除 | ○ |
| TRACE | 通信経路の確認 | |
| CONNECT | プロキシのトンネル接続 | |

# HTTPレスポンス
レスポンスは3要素で構成される。
- ステータスライン
- ヘッダー
- ボディ

## ステータスライン
HTTPバージョン、ステータスコード フレーズ
ステータスコードとフレーズは5種類
200、400、500はよく見る

## 200
正常処理

## 400
クライアントエラー
リクエストに誤りがある

## 500
サーバーエラー。サーバー処理失敗

## ヘッダー
meta情報


# 安全性と冪等性
## 副作用
リソース（データ）が改変されること

### 副作用がある
データを更新

### 副作用がない
データを取得
厳密にはアクセスログが出力されるためリソース変化はあるが、データの改変は行われない

## 安全
副作用がないこと
リソースの状態を変化させない読み取り専用である。
つまり、データの取得（GET、HEAD）

## 冪等
副作用の有無を問わない。
何度実行しても同じ状態で再現される。

### 副作用があるケース
PUT、DELETE

### 副作用がない
データ取得

### 安全でも冪等でもない
データ登録。
POST


# RESTfulとは
「RESTで求められる原則にしたがっている」こと

## RESTとは
REpresentational State Transfer
分散型システムにおける設計原則群=設計ルール

## REST原則
REST原則は6種類（7種類だけど6種類でいいよ）。
- nullスタート（これはいいかも）
- クライアント/サーバー
- ステートレス
- キャッシュ制御
- 統一インターフェース
- 階層化システム
- コードオンデマンド


# クライアントサーバー
ネットワークベースのアプリケーションではよくある構成。
「画面（UI）」と「データ」で関心事を分離する。
クライアント側がトリガー、サーバー側は受け身。
（最近はサーバー側もPUSHしたりするけどね）

# 階層化システム
多層アーキテクチャ構成。

クライアント
→WEB→AP→DB
→WEB→AP→DB
→WEB→AP→DB

この時の1つのwebサーバーをコンポーネントと呼んでいる

## メリット
各システム（コンポーネント）に役割を決めて独立させることで進化と再利用が促進できる
例えばレガシーシステムのカプセル化などマイクロサービスのような概念

## デメリット
データ処理にオーバーヘッドが発生する
→ユーザーから見ると応答が悪くなる

改善案：キャッシュを利用する


# コードオンデマンド
クライアントコードをダウンロードして実行できる。

- リリース後にクライアントコードを変更できる。
例：HTML自体の更新、javaアプレットの更新
クライアント側はサーバーからダウンロードして使うから

## メリット
- リリース済みのクライアントに対して機能追加できる。
- サーバーの負荷が下がる（クライアントに処理が以上できるため）

## デメリット
- 評価環境が複雑になる（多数のブラウザとか）


# 統一インターフェース
4つの制約からなっている。

## 制約
- リソースの識別
- 表現を用いたリソース操作
- 自己記述メッセージ
- アプリケーション状態エンジンとしてのハイパーメディア（HATEOAS）

### リソースの識別
リソース...名前が付けられるあらゆるもの。
抽象的な定義も含む。「最新（今日の天気）」「ある断面（4月1日の天気）」
例）サーバー側に保持されるデータ。

URIを用いてサーバーに保存されたデータを識別する。

つまり、URIはリソースを識別するもの。
URIに動作は含まない。

### 表現を用いたリソース操作
表現...リソースのある断面。クライアントへ返されるレスポンスやサーバーへPOSTするデータ。

つまり、断面情報を利用してサーバー上のデータを操作する。
- リソースなる断面が表現
- クライアントからサーバーへ編集リクエストをする際、認証情報などの追加情報を付与する。

### 自己記述メッセージ
メッセージ内容がなんであるか、ヘッダーに記述されている。
- レスポンスに含まれるメタ情報（ヘッダー情報）で内容がどのようなものかわかる。

### アプリケーション状態エンジンとしてのハイパーメディア（HATEOAS）
Hypermedia as the Engine of Application State
- レスポンスに現在の状態を踏まえて関連するハイパーリンクが含まれる
例）検索結果ページにおける「次のページ」。2000年代はあった。

## 統一インターフェースを守ることへのメリット、デメリット
### メリット
システムアーキテクチャ全体が簡素化されてわかりやすくなる。
提供するサービスに集中でき、独自の進化ができる。
異なるプラウザでも同じような画面を表示できる。

### デメリット
標準化によって効率が犠牲になる。



# ステートレス
## ステートレスとステートフル
### ステートフル
前の状態を保存
前の会話と次の会話が関連

### ステートレス
前の状態を保存しない
それぞれの会話が独立して成立

つまり、
サーバーはリクエストだけでもんテキストを理解できる。
- サーバーに保存されたコンテキスト情報は使わない（サーバーセッションは使わない）
- 状態はクライアント上に保存される（リクエストにすべて含む）

## メリット
単一のリクエスト以外見る必要がないので監視が容易
障害発生したりリクエストだけ回復すればいいので、障害復旧が容易
リクエスト全体でサーバーリソースを共有する必要がないのでスケールが容易

## デメリット
単一のリクエストで完結させるため、リクエストデータに重複がある。
アプリを複数バージョン同時提供し、状態をクライアントに置いておくとアプリ制御が複雑になる。



# キャッシュ制御
クライアント側でレスポンスをキャッシュできるようにする。

- レスポンスは明示的または暗黙的にキャッシュ可能。
- キャッシュを適切に行うことでクライアント/サーバー間の通信が排除され、ユーザー体験の向上、リソース効率の向上、拡張性の向上が見込める。

キャッシュを適切に行うことで必要な情報だけリクエストすればよくなる。

## メリット
- ユーザー体験の向上
- リソース効率の向上
- 拡張性の向上

## デメリット
- 古いデータを戻してしまうとシステムに対する信頼性の低下につながる



# REST API 成熟度モデル
設計レベルは4段階。

## LEVEL 0
HTTPを使っている

REST APIの基本レベル。RPCスタイルのXML通信。
- HTTPは単なる通信手段として利用
- 1URLですべて完結
- リクエストボディに処理と引数が含まれる

## LEVEL 1
リソースの概念を導入

- リソースごとにURLを分割
- HTTPメソッドはかつようできていないのでGETかPOSTのみで通信

## LEVEL 2
HTTPの動詞を導入

LEVEL1に加えてHTTPメソッドを活用

- リソースに対してHTTPメソッドを使ったCRUD操作が行われている。

## LEVEL 3
HATEOASの概念の導入

LEVEL2に加えてレスポンスにリソース間のつながりが含まれる。
- レスポンスに現在の状態に関連するハイパーリンクが含まれる（=HATEOASに相当する情報がレスポンスに含まれる）



# URIの設計
## URI設計で考慮すること
- 短く入力しやすい（冗長なパスを含まない）=>シンプルで覚えやすいものにすることで入力ミスを防ぐ
例）  
[NG] GET https://api.example.com/service/api/search  
[OK] GET https://api.example.com/search

## 人が読んで理解できる（できるだけ省略しない）
=>その省略は自己満足でないか。国や文化が変わっても不変な表記にすることでご認識を防ぐ  
例）  
[NG] GET https://api.example.com/sv/u  
[OK] GET https://api.example.com/users  

## 大文字、小文字が混在していない（全て小文字）

## 単語はハイフンでつなげる
=>アンダースコアはタイプライターで下線を引くためのものであった。ハイフンは単語をつなぐためのもの。

## 単語は複数形を利用する
=> URIで表現しているのは「リソースの集合」

## エンコードを必要とした文字を使わない
=> URIから意味が理解できない

NG）
[NG] GET https://api.example.com/ユーザー
=> https://api.example.com/%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC

## サーバー側のアーキテクチャを反映しない
=> 悪意あるユーザーに脆弱性を突かれる危険がある

NG）
GET https://api.example.com/cgi-bin/get_user.php?=12345
GET https://api.example.com/users/12345

phpが動いていることがわかる

## 改造しやすい（Hackable）
=> システム依存の設計は意味が理解できない

NG）
GET https://api.example.com/items/alpha/12345
GET https://api.example.com/items/bata/12345

OK）
GET https://api.example.com/items/12345

## ルールが統一されている
=> 一定のルールに従って設計することで間違いを防ぐ

NG）
情報取得
GET https://api.example.com/friends?id=12345
メッセージ投稿
GET https://api.example.com/friends12345/message/

OK）  
情報取得
GET https://api.example.com/friends/12345
メッセージ投稿
GET https://api.example.com/friends/12345/message/

