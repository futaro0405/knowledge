Rails6.0 | 20 | Webアプリケーション開発 | カートの作成
https://mrradiology.hatenablog.jp/entry/2020/06/05/065251
セッションカートに保存
```
bin/rails generate scaffold cart
```

```
rails db:migrate
```

```ruby:app/controllers/concerns/current_cart.rb
module CurrentCart
	private
	def set_cart
		@cart = Cart.find(session[:cart_id])
		rescue ActiveRecord::RecordNotFound
		@cart = Cart.create
		session[:cart_id] = @cart.id
	end
end
```

```
bin/rails generate scaffold LineItem good:references cart:belongs_to
rails db:migrate
```

```ruby:app/models/line_item.rb
class LineItem < ApplicationRecord
	belongs_to :good
	belongs_to :cart
end
```

```ruby:app/models/cart.rb
class Cart < ApplicationRecord
	has_many :line_items, dependent: :destroy
end
```

```ruby:app/models/good.rb
class Good < ApplicationRecord
	has_many :line_items
	before_destroy :ensure_not_referenced_by_any_lin_items

	validates :title, :description, :image_url, presence: true
	validates :price, numericality: {greater_than_or_equal_to: 1}
	validates :title, uniqueness: true

	validates :image_url, allow_blank: true, format: {
		with: %r{\.(gif|jpg|png)\z}i,
		message: 'はGIF、JPG、PNG画像のURLでなければなりません。'
	}

	private
	 # この商品を参照しているLineItemがないことを確認する
	def ensure_not_referenced_by_any_line_items
		unless line_items.empty?
			errors.add(:base, '品目が存在します。')
			throw :abort
		end
	end
end
```
カートに入れるボタン
```html:app/views/market/index.html.erb
<% if notice %>
	<aside id="notice"><%= notice %></aside>
<% end %>
<h1>Railsはじめてマート　商品カタログ</h1>
<br>
<ul class="catalog">
	<% @goods.each do |good| %>
		<li>
			<%= image_tag(good.image_url, width: 140) %>
			<h2><%= good.title %></h2>
			<p><%= sanitize(good.description) %></p>
			<div class="price">
				<%= (good.price).to_i %>円
				<%= button_to 'カートに入れる', line_items_path(good_id: good ) %>
			</div>
		</li>
	<% end %>
</ul>
```
LineItem Controllerを修正
```ruby:app/controllers/line_items_controller.rb
class LineItemsController < ApplicationController
	include CurrentCart
	before_action :set_cart, only: [:create]
	before_action :set_line_item, only: [:show, :edit, :update, :destroy]
	
	# GET /line_items
	# GET /line_items.json
	def index
		@line_items = LineItem.all
	end
	
	# GET /line_items/1
	# GET /line_items/1.json
	def show
	end
	
	# GET /line_items/new
	def new
		@line_item = LineItem.new
	end
	
	# GET /line_items/1/edit
	def edit
	end
	
	# POST /line_items
	# POST /line_items.json
	def create
		good = Good.find(params[:good_id])
		@line_item = @cart.line_items.build(good: good)
		respond_to do |format|
			if @line_item.save
				format.html { redirect_to @line_item.cart, notice: '品目が作成されました。' }
				format.json { render :show, status: :created, location: @line_item }
			else
				format.html { render :new }
				format.json { render json: @line_item.errors, status: :unprocessable_entity }
			end
		end
	end
	
	# PATCH/PUT /line_items/1
	# PATCH/PUT /line_items/1.json
	def update
		respond_to do |format|
			if @line_item.update(line_item_params)
				format.html { redirect_to @line_item, notice: '品目が更新されました。' }
				format.json { render :show, status: :ok, location: @line_item }
			else
				format.html { render :edit }
				format.json { render json: @line_item.errors, status: :unprocessable_entity }
			end
		end
	end
	
	# DELETE /line_items/1
	# DELETE /line_items/1.json
	def destroy
		@line_item.destroy
		respond_to do |format|
			format.html { redirect_to line_items_url, notice: '品目を破棄しました。' }
			format.json { head :no_content }
		end
	end

	private
	
	# Use callbacks to share common setup or constraints between actions.
	def set_line_item
		@line_item = LineItem.find(params[:id])
	end
	
	# Only allow a list of trusted parameters through.
	def line_item_params
		params.require(:line_item).permit(:good_id, :cart_id)
	end
end
```


[RailsでECサイトのカート機能を実装する](https://zenn.dev/akhmgc/articles/2d060378c4260e)
```
class CreateCartItems < ActiveRecord::Migration[6.0]
	def change
		create_table :cart_items do |t|
			t.integer :quantity, default: 0
			t.references :product, null: false, foreign_key: true
			t.references :cart, null: false, foreign_key: true
			t.timestamps
		end
	end
end
```

```

class CreateCarts < ActiveRecord::Migration[6.0]
	def change
	    create_table :carts do |t|
			# sessionで管理する場合user_idはnullになるのでnull: falseは不要
			t.references :carts, :user, foreign_key: true
			t.timestamps
		end
	end
end
```

```
class Cart < ApplicationRecord
	has_many :cart_items, dependent: :destroy
end
```

```
class CartItem < ApplicationRecord
	belongs_to :product
	belongs_to :cart

	# カート内の商品合計に利用
	def sum_of_price
		product.price * quantity
	end
end
```

```
class User < ApplicationRecord
	has_one :cart, dependent: :destroy
end
```

