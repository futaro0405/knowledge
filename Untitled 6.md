# 要件定義
## 目的
管理者がXLSXファイルをアップロードすることで多数のお酒情報を一括で登録できるようにし、個別登録の手間や入力ミスを減少させる。
## 対象
管理画面を操作するadminユーザーのみ
## 機能要件
- ファイルアップロード
	- XLSX形式のファイルのみ対応
	- ドラッグ＆ドロップまたはファイル選択でアップロード
- データパース・検証
	- アップロードしたファイルから各データを読み取る。
	- 必須項目の有無や数値チェックなどの簡易なデータ検証を実施。
- データ登録
	- 登録結果として、成功件数とエラーとなった行の情報をフィードバックする。
	- 検証済みのデータを一括登録する。

# 基本設計
## **フロントエンド**
- お酒詳細画面の改修
    - お酒詳細画面に、新たに一括登録画面への遷移ボタンを追加する。
- お酒一括登録画面の追加
	- XLSXファイルの選択、ドラッグ＆ドロップによる一括登録機能。
    - テンプレートのダウンロード機能を実装。
        - ダウンロードできるテンプレートは「alcohols」と「makers」の2シート構成。
    - アップロード結果（成功件数、エラー内容）の表示。
---
## **バックエンド**
- API提供:
	- 管理画面からアップロードされたXLSXファイルを受け取り、パース、検証、更新処理を実行するAPIを提供。
- 処理フロー:
	- アップロードファイルの検証:
		- ファイル形式およびサイズの検証
    - XLSXファイルのパース:
		- テンプレートに準拠した2シート（alcohols、makers）を対象とする。
    - 各行のチェックを実施:
		- 必須項目のチェック
		- データ重複チェック（既存データとの重複防止）
    - 更新処理:
		- 登録対象は、既存システムのDB上のテーブル以下:
			- alcohols
			- alcohol_images
			- medias
			- makers
		- 検証結果が正常な行をトランザクション管理下で登録処理を実施する。
	- フィードバック:
		- エラーがある場合は、対象行のエラーメッセージを返し、問題解消後の再アップロードを促す。
---
## **データベース**
- お酒テーブルの更新:
	- 登録対象は、既存のデータベーステーブルに対応する以下のテーブル:
		- alcohols
		- alcohol_images
		- medias
		- makers
	- テンプレートの「alcohols」シートは、分割管理されていた各種情報をひとまとめにしており、これらのテーブルへ適切にマッピングされるよう更新処理を実施。

|     |                                                                       |                     |                    |                    |     |      |                                   |              |                                                                                                                                                                                    |                                                                                                                                                                                           |                                                                                                   |     |
| --- | --------------------------------------------------------------------- | ------------------- | ------------------ | ------------------ | --- | ---- | --------------------------------- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- | --- |
| 2   | product_code ![インデックス](http://localhost:8080/themes/dot.gif "インデックス") | varchar(50)         | utf8mb4_general_ci |                    | いいえ | _なし_ | ブランド名, urlに使用, 重複・変更不可, 半角小文字英数のみ |              | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=product_code&change_column=1) | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql)                                                                                         | その他                                                                                               |     |
|     | 3                                                                     | maker_id            | varchar(36)        | utf8mb4_0900_ai_ci |     | いいえ  | _なし_                              | メーカーID       |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=maker_id&change_column=1)            | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 4                                                                     | genre_id            | varchar(36)        | utf8mb4_0900_ai_ci |     | いいえ  | _なし_                              | ジャンルID       |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=genre_id&change_column=1)            | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 5                                                                     | product_name        | varchar(50)        | utf8mb4_0900_ai_ci |     | いいえ  | _なし_                              | 商品名          |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=product_name&change_column=1)        | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 6                                                                     | alcohol_content     | double             |                    |     | いいえ  | _なし_                              | アルコール度数      |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=alcohol_content&change_column=1)     | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 7                                                                     | explanation         | varchar(255)       | utf8mb4_0900_ai_ci |     | いいえ  | _なし_                              | 製品説明         |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=explanation&change_column=1)         | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 8                                                                     | product_information | json               |                    |     | いいえ  | _なし_                              | 製品情報         |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=product_information&change_column=1) | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 9                                                                     | release_date        | varchar(50)        | utf8mb4_0900_ai_ci |     | いいえ  | _なし_                              | 販売日          |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=release_date&change_column=1)        | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 10                                                                    | main_medium_id      | varchar(36)        | utf8mb4_0900_ai_ci |     | はい   | _NULL_                            | メイン画像ID      |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=main_medium_id&change_column=1)      | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 11                                                                    | ogp_id              | varchar(36)        | utf8mb4_0900_ai_ci |     | はい   | _NULL_                            | OGPID        |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=ogp_id&change_column=1)              | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 12                                                                    | product_page        | varchar(255)       | utf8mb4_0900_ai_ci |     | いいえ  | _なし_                              | 製品ページ        |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=product_page&change_column=1)        | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 13                                                                    | is_suspend          | tinyint(1)         |                    |     | いいえ  | 0                                 | 非掲載フラグ       |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=is_suspend&change_column=1)          | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 14                                                                    | amazon_url          | varchar(255)       | utf8mb4_0900_ai_ci |     | いいえ  | _なし_                              | AmazonアフィURL |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=amazon_url&change_column=1)          | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 15                                                                    | rakuten_url         | varchar(255)       | utf8mb4_0900_ai_ci |     | いいえ  | _なし_                              | 楽天アフィURL     |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=rakuten_url&change_column=1)         | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 16                                                                    | like_num            | int                |                    |     | いいえ  | 0                                 | いいね数         |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=like_num&change_column=1)            | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 17                                                                    | maker_deleted_at    | datetime           |                    |     | はい   | _NULL_                            | メーカー削除日      |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=maker_deleted_at&change_column=1)    | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 18                                                                    | register_at         | datetime           |                    |     | いいえ  | _なし_                              | RegisterAt   |                                                                                                                                                                                    | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=register_at&change_column=1)         | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 19                                                                    | created_at          | datetime           |                    |     | いいえ  | CURRENT_TIMESTAMP                 | レコード登録日時     | DEFAULT_GENERATED                                                                                                                                                                  | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=created_at&change_column=1)          | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 20                                                                    | updated_at          | datetime           |                    |     | いいえ  | CURRENT_TIMESTAMP                 | レコード更新日時     | DEFAULT_GENERATED                                                                                                                                                                  | [![変更](http://localhost:8080/themes/dot.gif "変更") 変更](http://localhost:8080/index.php?route=/table/structure/change&db=scaffold&table=alcohols&field=updated_at&change_column=1)          | [![削除](http://localhost:8080/themes/dot.gif "削除") 削除](http://localhost:8080/index.php?route=/sql) | その他 |
|     | 21                                                                    | deleted_at          |                    |                    |     |      |                                   |              |                                                                                                                                                                                    |                                                                                                                                                                                           |                                                                                                   |     |